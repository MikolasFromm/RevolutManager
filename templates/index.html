{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Current Balance:</h5>
        <div id="balance" class="display-6">Loading...</div>
        <div id="totals" class="mt-2"></div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body py-3">
        <h6 class="card-title mb-2">Actions</h6>
        <form id="incomeForm" class="mb-1">
          <div class="row g-1 align-items-center mb-1">
            <div class="col-2">
              <small class="text-muted">Income</small>
            </div>
            <div class="col-2">
              <input name="amount" class="form-control form-control-sm" placeholder="Amount">
            </div>
            <div class="col-3">
              <select name="rate_id" class="form-control form-control-sm" required>
                <option value="">Rate...</option>
              </select>
            </div>
            <div class="col-3">
              <input name="description" class="form-control form-control-sm" placeholder="Description">
            </div>
            <div class="col-2">
              <button class="btn btn-success btn-sm w-100" type="submit">Add</button>
            </div>
          </div>
          <div class="row g-1 align-items-center mb-1">
            <div class="col-2"></div>
            <div class="col-10">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="fixed_rate" id="fixedRate" checked>
                <label class="form-check-label" for="fixedRate">
                  <small>Fix rate</small>
                </label>
              </div>
            </div>
          </div>
        </form>

        <form id="costForm" class="mb-1">
          <div class="row g-1 align-items-center mb-1">
            <div class="col-2">
              <small class="text-muted">Cost</small>
            </div>
            <div class="col-2">
              <input name="amount" class="form-control form-control-sm" placeholder="Amount">
            </div>
            <div class="col-3">
              <select name="rate_id" class="form-control form-control-sm" required>
                <option value="">Rate...</option>
              </select>
            </div>
            <div class="col-3">
              <input name="description" class="form-control form-control-sm" placeholder="Description">
            </div>
            <div class="col-2">
              <button class="btn btn-danger btn-sm w-100" type="submit">Add</button>
            </div>
          </div>
        </form>

        <form id="expectedForm" class="mb-1">
          <div class="row g-1 align-items-center mb-1">
            <div class="col-2">
              <small class="text-muted">Expected</small>
            </div>
            <div class="col-2">
              <input name="amount" class="form-control form-control-sm" placeholder="Amount">
            </div>
            <div class="col-3">
              <select name="rate_id" class="form-control form-control-sm" required>
                <option value="">Rate...</option>
              </select>
            </div>
            <div class="col-3">
              <input name="description" class="form-control form-control-sm" placeholder="Description">
            </div>
            <div class="col-2">
              <button class="btn btn-primary btn-sm w-100" type="submit">Add</button>
            </div>
          </div>
        </form>

        <div id="messages"></div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="card-title mb-0">Exchange Rates</h6>
          <button class="btn btn-outline-info btn-sm" onclick="updateCnbRates()">Update CNB</button>
        </div>
        <form id="rateForm" class="mb-2">
          <div class="row g-1 align-items-center mb-2">
            <div class="col-1">
              <input name="from_currency" class="form-control form-control-sm" placeholder="From" maxlength="3">
            </div>
            <div class="col-auto">
              <span class="small">→</span>
            </div>
            <div class="col-1">
              <input name="to_currency" class="form-control form-control-sm" placeholder="To" maxlength="3">
            </div>
            <div class="col-2">
              <input name="rate" class="form-control form-control-sm" placeholder="Rate" type="number" step="any">
            </div>
            <div class="col-3">
              <input name="description" class="form-control form-control-sm" placeholder="Description" maxlength="255">
            </div>
            <div class="col-auto">
              <button class="btn btn-outline-primary btn-sm" type="submit">Add</button>
            </div>
          </div>
        </form>
        <div id="ratesList" class="mt-2" style="font-size: 0.9em;">Loading rates...</div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Expected Costs</h5>
        <div id="expectedList" class="scrollable-list">Loading...</div>
      </div>
    </div>
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="card-title">Recent Incomes</h5>
        <div id="incomesList" class="scrollable-list">Loading...</div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="card-title">Recent Costs</h5>
        <div id="costsList" class="scrollable-list">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
let availableRates = [];

async function loadRates(){
  const res = await fetch('/rates');
  const data = await res.json();
  availableRates = data.rates || [];
  
  // Update all rate dropdowns
  const rateSelects = document.querySelectorAll('select[name="rate_id"]');
  rateSelects.forEach(select => {
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Rate...</option>';
    availableRates.forEach(rate => {
      const option = document.createElement('option');
      option.value = rate.id;
      option.textContent = `${rate.name} (${rate.rate.toFixed(4)}) → ${rate.to_currency}`;
      if(currentValue == rate.id) option.selected = true;
      select.appendChild(option);
    });
  });
  
  // Update rates management list
  const ratesList = document.getElementById('ratesList');
  if(availableRates.length === 0){
    ratesList.innerHTML = '<div class="text-muted">No rates defined</div>';
    return;
  }
  
  let html = '<div class="list-group list-group-flush">';
  availableRates.forEach(rate => {
    const isOfficial = !rate.description;
    const badgeClass = isOfficial ? 'bg-primary' : 'bg-secondary';
    const badgeText = isOfficial ? 'CNB' : rate.description;
    
    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>${rate.from_currency}-${rate.to_currency}</strong>
        <span class="badge ${badgeClass} ms-2">${rate.rate.toFixed(4)}</span>
        ${rate.description ? `<br><small class="text-muted">${rate.description}</small>` : '<br><small class="text-muted">Official CNB rate</small>'}
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editRate(${rate.id}, ${rate.rate})">Edit</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteRate(${rate.id})" ${isOfficial ? 'title="Cannot delete official rates"' : ''} ${isOfficial ? 'disabled' : ''}>Delete</button>
      </div>
    </div>`;
  });
  html += '</div>';
  ratesList.innerHTML = html;
}
async function loadBalance(){
  const res = await fetch('/balance');
  const data = await res.json();
  document.getElementById('balance').textContent = `${data.balance.toFixed(2)} (${data.balance_czk.toFixed(2)} CZK)`;
  document.getElementById('totals').innerHTML = `
    <small>Income: ${data.total_income.toFixed(2)} <span class="text-muted">(${data.total_income_czk.toFixed(2)} CZK)</span></small><br>
    <small>Costs: ${data.total_costs.toFixed(2)} <span class="text-muted">(${data.total_costs_czk.toFixed(2)} CZK)</span></small><br>
    <small>Expected: ${data.total_expected_remaining.toFixed(2)} <span class="text-muted">(${data.total_expected_remaining_czk.toFixed(2)} CZK)</span></small>
  `;
}

async function loadExpected(){
  const res = await fetch('/expected');
  const data = await res.json();
  const list = data.expected;
  const root = document.getElementById('expectedList');
  if(list.length===0){ root.innerHTML = '<div class="text-muted">No expected costs yet</div>'; return; }
  let html='';
  html += '<ul class="list-group">';
  for(const e of list){
    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>${e.description||'(no description)'}</strong><br>
        Amount: ${e.amount.toFixed(2)} ${e.currency} (${e.rate_name})<br>
        Remaining: ${e.remaining.toFixed(2)} GBP
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editExpected(${e.id})">Edit</button>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="promptCut(${e.id})">Cut</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteExpected(${e.id})">Delete</button>
      </div>
    </li>`;
  }
  html += '</ul>';
  root.innerHTML = html;
}

async function loadIncomes(){
  const res = await fetch('/income');
  const data = await res.json();
  const list = data.incomes || [];
  const root = document.getElementById('incomesList');
  if(list.length===0){ root.innerHTML = '<div class="text-muted">No incomes yet</div>'; return; }
  let html = '<ul class="list-group">';
  for(const i of list){
  const rateType = i.fixed_rate ? 'fixed' : 'dynamic';
  const normAmount = i.current_norm_amount.toFixed(2);
  
  html += `<li class="list-group-item d-flex justify-content-between align-items-center">
    <div>
      ${i.description||'(no desc)'}<br>
      <small class="text-muted">${new Date(i.date).toLocaleString()}</small><br>
      <span class="badge bg-${i.fixed_rate ? 'secondary' : 'primary'}">${rateType} rate</span>
    </div>
    <div>
      ${i.amount.toFixed(2)} ${i.currency} → ${normAmount} GBP<br>
      <small class="text-muted">${i.rate_name} (${i.fixed_rate ? 'original: ' + i.rate.toFixed(4) : 'current: ' + (i.current_norm_amount/i.amount).toFixed(4)})</small>
    </div>
    <div class="ms-3">
      <button class="btn btn-sm btn-outline-primary me-1" onclick="editIncome(${i.id})">Edit</button>
      <button class="btn btn-sm btn-outline-danger" onclick="deleteIncome(${i.id})">Delete</button>
    </div>
  </li>`;
  }
  html += '</ul>';
  root.innerHTML = html;
}

async function loadCosts(){
  const res = await fetch('/cost');
  const data = await res.json();
  const list = data.costs || [];
  const root = document.getElementById('costsList');
  if(list.length===0){ root.innerHTML = '<div class="text-muted">No costs yet</div>'; return; }
  let html = '<ul class="list-group">';
  for(const c of list){
  html += `<li class="list-group-item d-flex justify-content-between align-items-center">
    <div>
      ${c.description||'(no desc)'}<br>
      <small class="text-muted">${new Date(c.date).toLocaleString()}</small>
    </div>
    <div>
      ${c.amount.toFixed(2)} ${c.currency}<br>
      <small class="text-muted">${c.rate_name} (${c.rate.toFixed(4)})</small>
    </div>
    <div class="ms-3">
      <button class="btn btn-sm btn-outline-primary me-1" onclick="editCost(${c.id})">Edit</button>
      <button class="btn btn-sm btn-outline-danger" onclick="deleteCost(${c.id})">Delete</button>
    </div>
  </li>`;
  }
  html += '</ul>';
  root.innerHTML = html;
}

async function deleteIncome(id){
  const res = await fetch(`/income/${id}`, {method:'DELETE'});
  if(!res.ok){ const d = await res.json(); showMsg(d.error||'Error', 'alert-danger'); return; }
  showMsg('Income deleted','alert-success');
  await loadIncomes();
  await loadBalance();
}

async function deleteCost(id){
  const res = await fetch(`/cost/${id}`, {method:'DELETE'});
  if(!res.ok){ const d = await res.json(); showMsg(d.error||'Error', 'alert-danger'); return; }
  showMsg('Cost deleted','alert-success');
  await loadExpected();
  await loadCosts();
  await loadBalance();
}

async function deleteExpected(id){
  const res = await fetch(`/expected/${id}`, {method:'DELETE'});
  if(!res.ok){ const d = await res.json(); showMsg(d.error||'Error', 'alert-danger'); return; }
  showMsg('Expected deleted','alert-success');
  await loadExpected();
  await loadBalance();
  await loadCosts();
}

async function deleteRate(id){
  if(!confirm('Delete this rate? This will fail if the rate is being used.')) return;
  const res = await fetch(`/rates/${id}`, {method:'DELETE'});
  if(!res.ok){ const d = await res.json(); showMsg(d.error||'Error', 'alert-danger'); return; }
  showMsg('Rate deleted','alert-success');
  await loadRates();
}

async function editRate(id, currentRate){
  const newRate = prompt(`Edit rate (current: ${currentRate}):`, currentRate);
  if(!newRate || newRate == currentRate) return;
  const res = await fetch(`/rates/${id}`, {
    method:'PUT', 
    headers:{'Content-Type':'application/json'}, 
    body: JSON.stringify({rate: parseFloat(newRate)})
  });
  if(!res.ok){ const d = await res.json(); showMsg(d.error||'Error', 'alert-danger'); return; }
  const data = await res.json();
  showMsg(`Rate updated${data.inverse_updated ? ' (inverse also updated)' : ''}`, 'alert-success');
  await loadRates();
  await loadBalance();
  await loadExpected();
}

async function updateCnbRates(){
  showMsg('Updating rates from CNB...', 'alert-info');
  const res = await fetch('/rates/update-cnb', {method:'POST'});
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error updating rates', 'alert-danger'); return; }
  showMsg('Rates updated from CNB successfully!', 'alert-success');
  await loadRates();
  await loadBalance();
  await loadExpected();
}

function showMsg(text, cls='alert-info'){
  const box = document.getElementById('messages');
  box.innerHTML = `<div class="alert ${cls} mt-2" role="alert">${text}</div>`;
  setTimeout(()=>box.innerHTML='',4000);
}

async function submitForm(url, body){
  const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return res;
}

async function promptCut(id){
  const val = prompt('Amount to cut from this expected?');
  if(!val) return;
  const res = await submitForm(`/expected/${id}/cut`, {amount:parseFloat(val)});
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error', 'alert-danger'); return; }
  showMsg('Cut created. Remaining: '+data.expected_remaining.toFixed(2),'alert-success');
  await loadExpected();
  await loadBalance();
  await loadCosts();
}

async function editIncome(id){
  // Find the income data first
  const res = await fetch('/income');
  const data = await res.json();
  const income = data.incomes.find(i => i.id === id);
  if(!income) { showMsg('Income not found', 'alert-danger'); return; }
  
  const newAmount = prompt(`Edit amount (current: ${income.amount}):`, income.amount);
  const newDescription = prompt(`Edit description (current: ${income.description || ''}):`, income.description || '');

  if ((!newAmount || newAmount == income.amount) && (newDescription === null || newDescription === income.description)) return;
  
  const updateRes = await fetch(`/income/${id}`, {
    method:'PUT', 
    headers:{'Content-Type':'application/json'}, 
    body: JSON.stringify({
      amount: parseFloat(newAmount),
      description: newDescription
    })
  });
  
  if(!updateRes.ok){ 
    const d = await updateRes.json(); 
    showMsg(d.error||'Error', 'alert-danger'); 
    return; 
  }
  
  showMsg('Income updated successfully', 'alert-success');
  await loadIncomes();
  await loadBalance();
}

async function editCost(id){
  // Find the cost data first
  const res = await fetch('/cost');
  const costData = await res.json();
  const cost = costData.costs.find(c => c.id === id);
  if(!cost) { showMsg('Cost not found', 'alert-danger'); return; }

  const newAmount = prompt(`Edit amount (current: ${cost.amount}):`, cost.amount);
  const newDescription = prompt(`Edit description (current: ${cost.description || ''}):`, cost.description || '');

  if ((!newAmount || newAmount == cost.amount) && (newDescription === null || newDescription === cost.description)) return;
    
  const updateRes = await fetch(`/cost/${id}`, {
      method:'PUT', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({
        amount: parseFloat(newAmount),
        description: newDescription
      })
    });
    
    if(!updateRes.ok){ 
      const d = await updateRes.json(); 
      showMsg(d.error||'Error updating cost', 'alert-danger'); 
      return; 
    }
  
  showMsg('Cost updated successfully', 'alert-success');
  await loadCosts();
  await loadBalance();
}

async function editExpected(id){
  // Find the expected cost data first
  const res = await fetch('/expected');
  const expectedData = await res.json();
  const expected = expectedData.expected.find(e => e.id === id);
  if(!expected) { showMsg('Expected cost not found', 'alert-danger'); return; }

  const newAmount = prompt(`Edit amount (current: ${expected.amount}):`, expected.amount);
  const newDescription = prompt(`Edit description (current: ${expected.description || ''}):`, expected.description || '');

  if ((!newAmount || newAmount == expected.amount) && (newDescription === null || newDescription === expected.description)) return;

  const updateRes = await fetch(`/expected/${id}`, {
      method:'PUT', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({
        amount: parseFloat(newAmount),
        description: newDescription
      })
    });

  if(!updateRes.ok){ 
    const d = await updateRes.json(); 
    showMsg(d.error||'Error updating expected cost', 'alert-danger'); 
    return; 
  }
  
  showMsg('Expected cost updated successfully', 'alert-success');
  await loadExpected();
  await loadBalance();
}

document.getElementById('incomeForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  if(!f.rate_id.value) { showMsg('Please select a rate', 'alert-danger'); return; }
  const body = {
    amount: parseFloat(f.amount.value), 
    rate_id: parseInt(f.rate_id.value), 
    description: f.description.value,
    fixed_rate: f.fixed_rate.checked
  };
  const res = await submitForm('/income', body);
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error', 'alert-danger'); return; }
  const rateType = data.fixed_rate ? 'fixed' : 'dynamic';
  showMsg(`Income added: ${data.norm_amount.toFixed(2)} GBP (${data.currency}, ${rateType} rate)`, 'alert-success');
  f.reset();
  // Reset the checkbox to checked (default)
  f.fixed_rate.checked = true;
  await loadBalance();
  await loadIncomes();
});

document.getElementById('costForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  if(!f.rate_id.value) { showMsg('Please select a rate', 'alert-danger'); return; }
  const body = {amount: parseFloat(f.amount.value), rate_id: parseInt(f.rate_id.value), description: f.description.value};
  const res = await submitForm('/cost', body);
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error', 'alert-danger'); return; }
  showMsg(`Cost added (${data.currency})`, 'alert-success');
  f.reset();
  await loadBalance();
  await loadCosts();
});

document.getElementById('expectedForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  if(!f.rate_id.value) { showMsg('Please select a rate', 'alert-danger'); return; }
  const body = {amount: parseFloat(f.amount.value), rate_id: parseInt(f.rate_id.value), description: f.description.value};
  const res = await submitForm('/expected', body);
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error', 'alert-danger'); return; }
  showMsg(`Expected created (${data.currency})`, 'alert-success');
  f.reset();
  await loadExpected();
  await loadBalance();
  await loadCosts();
  await loadIncomes();
});

document.getElementById('rateForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const body = {
    from_currency: f.from_currency.value.toUpperCase(), 
    to_currency: f.to_currency.value.toUpperCase(), 
    rate: parseFloat(f.rate.value),
    description: f.description.value.trim() || undefined
  };
  const res = await submitForm('/rates', body);
  const data = await res.json();
  if(!res.ok){ showMsg(data.error || 'Error', 'alert-danger'); return; }
  showMsg(`Rate added${data.inverse_added ? ' (inverse also added)' : ''}`, 'alert-success');
  f.reset();
  await loadRates();
});

// initial load
loadRates();
loadBalance();
loadExpected();
loadIncomes();
loadCosts();
</script>

{% endblock %}
